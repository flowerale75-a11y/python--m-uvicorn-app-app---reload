<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BloomNext POS</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div>
        <h1>BloomNext POS</h1>
        <div class="muted">MVP • Scan barcode → add to cart → checkout</div>
      </div>
      <div class="pill" id="statusPill">Connecting…</div>
    </header>

    <div class="grid">
      <!-- LEFT: POS -->
      <section class="card">
        <h2>Register</h2>

        <div class="row">
          <label>Barcode</label>
          <div class="rowInline">
            <input id="barcodeInput" placeholder="Scan or type barcode…" autocomplete="off"/>
            <button id="addByBarcodeBtn">Add</button>
          </div>
          <div class="muted small">Tip: after scanning, press Enter.</div>
        </div>

        <div class="row">
          <label>Cart</label>
          <div class="tableWrap">
            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="right">Price</th>
                  <th class="center">Qty</th>
                  <th class="right">Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>
          </div>
          <div class="cartEmpty muted" id="cartEmpty">Cart is empty. Add items by barcode or from Products.</div>
        </div>

        <div class="row totals">
          <div class="totalsLeft">
            <div class="checkRow">
              <input type="checkbox" id="taxEnabled"/>
              <label for="taxEnabled">Apply tax</label>
              <input class="taxRate" id="taxRate" type="number" step="0.0001" min="0" max="0.25" value="0.0000" />
              <span class="muted small">rate</span>
            </div>
            <div class="muted small">Example NYC: 0.08875</div>
          </div>

          <div class="totalsRight">
            <div class="line"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
            <div class="line"><span>Tax</span><span id="tax">$0.00</span></div>
            <div class="line big"><span>Total</span><span id="total">$0.00</span></div>
          </div>
        </div>

        <div class="row">
          <label>Payment</label>
          <div class="rowInline">
            <select id="paymentMethod">
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="other">Other</option>
            </select>
            <button class="primary" id="checkoutBtn">Checkout</button>
            <button class="danger" id="clearCartBtn">Clear</button>
          </div>
        </div>

        <div class="row">
          <label>Receipt / Result</label>
          <pre id="receiptBox" class="receipt"></pre>
        </div>
      </section>

      <!-- RIGHT: Products + Orders -->
      <section class="card">
        <h2>Products</h2>

        <div class="row">
          <div class="rowInline">
            <input id="productSearch" placeholder="Search products…"/>
            <button id="refreshProductsBtn">Refresh</button>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Barcode</th>
                <th class="right">Price</th>
                <th class="center">Tax</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="productsBody"></tbody>
          </table>
        </div>

        <hr/>

        <h3>Add / Update Product</h3>
        <div class="rowInline">
          <input id="pName" placeholder="Name (e.g., Roses 60cm)"/>
          <input id="pBarcode" placeholder="Barcode (optional)"/>
        </div>
        <div class="rowInline">
          <input id="pPrice" type="number" step="0.01" min="0" placeholder="Price"/>
          <label class="inlineCheck"><input type="checkbox" id="pTaxable" checked/> Taxable</label>
          <button id="saveProductBtn">Save</button>
        </div>
        <div class="muted small" id="productHint">Tip: Save creates a new product. (Editing can be added next.)</div>

        <hr/>

        <h2>Recent Orders</h2>
        <div class="rowInline">
          <button id="refreshOrdersBtn">Refresh</button>
          <span class="muted small">Last 20 checkouts</span>
        </div>
        <div class="orders" id="ordersBox"></div>
      </section>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let PRODUCTS = [];
  let CART = []; // {product, qty}

  const money = (n) => "$" + (Number(n).toFixed(2));
  const sum = (arr) => arr.reduce((a,b)=>a+b,0);

  async function api(path, opts={}) {
    const res = await fetch(path, { headers: { "Content-Type":"application/json" }, ...opts });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || ("HTTP " + res.status));
    }
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return res.json();
    return res.text();
  }

  function setStatus(ok, msg) {
    const pill = $("statusPill");
    pill.textContent = msg;
    pill.className = "pill " + (ok ? "ok" : "bad");
  }

  function cartTotals() {
    const taxEnabled = $("taxEnabled").checked;
    const taxRate = Number($("taxRate").value || "0");

    const subtotal = sum(CART.map(i => (i.product.price * i.qty)));
    const taxableBase = sum(CART.filter(i => i.product.taxable).map(i => (i.product.price * i.qty)));
    const tax = (taxEnabled ? (taxableBase * taxRate) : 0);
    const total = subtotal + tax;

    $("subtotal").textContent = money(subtotal);
    $("tax").textContent = money(tax);
    $("total").textContent = money(total);

    return { subtotal, tax, total, taxEnabled, taxRate };
  }

  function renderCart() {
    const body = $("cartBody");
    body.innerHTML = "";
    $("cartEmpty").style.display = CART.length ? "none" : "block";

    for (const item of CART) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="name">${escapeHtml(item.product.name)}</div>
          <div class="muted small">${escapeHtml(item.product.barcode || "")}</div>
        </td>
        <td class="right">${money(item.product.price)}</td>
        <td class="center">
          <div class="qtyBox">
            <button class="qtyBtn" data-act="dec" data-id="${item.product.id}">-</button>
            <span class="qtyVal">${item.qty}</span>
            <button class="qtyBtn" data-act="inc" data-id="${item.product.id}">+</button>
          </div>
        </td>
        <td class="right">${money(item.product.price * item.qty)}</td>
        <td class="right"><button class="link dangerText" data-act="remove" data-id="${item.product.id}">Remove</button></td>
      `;
      body.appendChild(tr);
    }

    body.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = Number(btn.getAttribute("data-id"));
        const act = btn.getAttribute("data-act");
        const idx = CART.findIndex(x => x.product.id === id);
        if (idx < 0) return;

        if (act === "inc") CART[idx].qty += 1;
        if (act === "dec") CART[idx].qty = Math.max(1, CART[idx].qty - 1);
        if (act === "remove") CART.splice(idx, 1);

        renderCart();
        cartTotals();
      });
    });
  }

  function renderProducts() {
    const q = ($("productSearch").value || "").toLowerCase().trim();
    const body = $("productsBody");
    body.innerHTML = "";

    const filtered = PRODUCTS.filter(p => {
      if (!p.active) return false;
      if (!q) return true;
      return (p.name || "").toLowerCase().includes(q) || (p.barcode || "").toLowerCase().includes(q);
    });

    for (const p of filtered) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.name)}</td>
        <td class="muted small">${escapeHtml(p.barcode || "")}</td>
        <td class="right">${money(p.price)}</td>
        <td class="center">${p.taxable ? "Yes" : "No"}</td>
        <td class="right"><button class="link" data-id="${p.id}">Add</button></td>
      `;
      body.appendChild(tr);
    }

    body.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = Number(btn.getAttribute("data-id"));
        const p = PRODUCTS.find(x => x.id === id);
        if (!p) return;
        addToCart(p);
      });
    });
  }

  function addToCart(product) {
    const found = CART.find(x => x.product.id === product.id);
    if (found) found.qty += 1;
    else CART.push({ product, qty: 1 });
    renderCart();
    cartTotals();
  }

  async function refreshProducts() {
    PRODUCTS = await api("/api/products?active_only=true");
    renderProducts();
  }

  async function refreshOrders() {
    const orders = await api("/api/orders/recent?limit=20");
    const box = $("ordersBox");
    box.innerHTML = "";

    if (!orders.length) {
      box.innerHTML = `<div class="muted">No orders yet.</div>`;
      return;
    }

    for (const o of orders) {
      const div = document.createElement("div");
      div.className = "orderCard";
      div.innerHTML = `
        <div class="orderHead">
          <div><b>Order #${o.id}</b> <span class="muted small">${new Date(o.created_at).toLocaleString()}</span></div>
          <div><b>${money(o.total)}</b> <span class="muted small">(${o.payment_method})</span></div>
        </div>
        <div class="muted small">${o.items.map(i => `${escapeHtml(i.name)} x${i.qty}`).join(" • ")}</div>
      `;
      box.appendChild(div);
    }
  }

  async function addByBarcode() {
    const code = ($("barcodeInput").value || "").trim();
    if (!code) return;

    const p = await api("/api/products/lookup?barcode=" + encodeURIComponent(code));
    if (!p) {
      $("receiptBox").textContent = "Barcode not found: " + code + "\nAdd the product on the right (Products) then try again.";
      return;
    }
    addToCart(p);
    $("barcodeInput").value = "";
    $("barcodeInput").focus();
  }

  async function checkout() {
    if (!CART.length) return;

    const t = cartTotals();
    const payload = {
      items: CART.map(i => ({ product_id: i.product.id, qty: i.qty })),
      payment_method: $("paymentMethod").value,
      tax_enabled: t.taxEnabled,
      tax_rate: t.taxRate,
      notes: null
    };

    const order = await api("/api/orders", {
      method: "POST",
      body: JSON.stringify(payload)
    });

    // Print receipt in the box
    const lines = [];
    lines.push(`BLOOMNEXT POS`);
    lines.push(`Order #${order.id}`);
    lines.push(`Time: ${new Date(order.created_at).toLocaleString()}`);
    lines.push(`Payment: ${order.payment_method}`);
    lines.push(`--------------------------------`);
    for (const it of order.items) {
      lines.push(`${it.name} x${it.qty}  ${money(it.line_total)}`);
    }
    lines.push(`--------------------------------`);
    lines.push(`Subtotal: ${money(order.subtotal)}`);
    lines.push(`Tax:      ${money(order.tax)}`);
    lines.push(`TOTAL:    ${money(order.total)}`);
    $("receiptBox").textContent = lines.join("\n");

    // Clear cart
    CART = [];
    renderCart();
    cartTotals();
    await refreshOrders();
  }

  async function saveProduct() {
    const name = ($("pName").value || "").trim();
    const barcode = ($("pBarcode").value || "").trim();
    const price = Number($("pPrice").value || "0");
    const taxable = $("pTaxable").checked;

    if (!name) {
      $("productHint").textContent = "Name is required.";
      return;
    }

    try {
      await api("/api/products", {
        method: "POST",
        body: JSON.stringify({
          name,
          barcode: barcode || null,
          price,
          taxable,
          active: true
        })
      });
      $("productHint").textContent = "Saved ✅";
      $("pName").value = "";
      $("pBarcode").value = "";
      $("pPrice").value = "";
      $("pTaxable").checked = true;
      await refreshProducts();
    } catch (e) {
      $("productHint").textContent = "Error: " + e.message;
    }
  }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Wire up events
  $("addByBarcodeBtn").addEventListener("click", addByBarcode);
  $("barcodeInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") addByBarcode();
  });

  $("refreshProductsBtn").addEventListener("click", async () => {
    await refreshProducts();
    renderProducts();
  });

  $("productSearch").addEventListener("input", renderProducts);
  $("saveProductBtn").addEventListener("click", saveProduct);

  $("taxEnabled").addEventListener("change", cartTotals);
  $("taxRate").addEventListener("input", cartTotals);

  $("checkoutBtn").addEventListener("click", checkout);
  $("clearCartBtn").addEventListener("click", () => {
    CART = [];
    renderCart();
    cartTotals();
    $("receiptBox").textContent = "";
  });

  $("refreshOrdersBtn").addEventListener("click", refreshOrders);

  // Boot
  (async function init(){
    try {
      await api("/health");
      setStatus(true, "Online");
    } catch {
      setStatus(false, "Offline");
    }
    await refreshProducts();
    await refreshOrders();
    renderCart();
    cartTotals();
    $("barcodeInput").focus();
  })();
</script>
</body>
</html>
